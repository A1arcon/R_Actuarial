---
output:  pdf_document
header-includes:
  - \usepackage{pdfpages} % Para poner pdf's en Markdown
  - \usepackage[spanish]{babel} % Para que aparezca en español
  - \setcounter{tocdepth}{3} % Para el índice con profundidad 3
  - \usepackage[titles]{tocloft} %1. Para que no se vean los puntos en el índice
  - \renewcommand{\cftdot}{} %2. Para que no se vean los puntos en el índice
  - \usepackage{multicol}
  - \usepackage{amsmath,mathrsfs,amssymb,amsthm,commath,thmtools,enumerate}
  - \usepackage{tgtermes} %Letra monita.
  - \pagenumbering{gobble} %Para quitar el número de página.
  - \usepackage{caption}
  - \captionsetup[table]{name=Tabla}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhead[L]{Proyecto 1}
  - \fancyhead[C]{Estadística Espacial}
  - \fancyhead[R]{Alarcón González Edgar Gerardo}
---

\includepdf[pages={-}]{Portada.pdf}

```{r setup, include=FALSE}
# Vamos a poner las configuraciones de los chunk en este caso
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message = FALSE,
                      out.width='70%',fig.align='center',
                      error=FALSE,quietly=TRUE)
```


```{r}
# Vamos a cargar los datos necesarios para trabajar con el proyecto
setwd("~/Actuaría/Maestría/3er. Semestre/Estadística Espacial/proyecto1")
library(geoR)
library(ggplot2)
library(lattice)
library(gstat)
library(sp)
library(dplyr)
library(knitr)
library(kableExtra)

#Extraemos los datos y los hacemos 
lluvia <- read.csv("lluvia.csv") %>% dplyr::select(-sdev)
contorno <- read.csv("contorno.csv")
#Separamos la base de datos para un mes (Sin pérdida de generalidad)
lluvia_mes <- lluvia[lluvia[,3]==1,]
#Transformamos las coordenadas de contorno
contorno$longitud = (contorno$V1-(min(contorno$V1)+.15))*60*1.82
contorno$latitud = (contorno$V2-(min(contorno$V2)+1))*60*1.82
```

\tableofcontents

\newpage

# 1. Introducción y Antecedentes

Primeramente vamos a observar un fragmento de la tabla que vamos a trabajar, la cual contiene mediciones, agrupadas por mes, realizadas por estaciones meteorológicas en México en los estados de Baja California Norte, Baja California Sur, Sonora y Sinaloa.

```{r}
aux<-head(lluvia)
kable(aux, "latex", caption = paste0("Fragmento de tabla de los datos de lluvia"),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

- \texttt{longitud}: Coordenada de longitud convertida en km de la estación meteorológica.

- \texttt{latitud}: Coordenada de latitud convertida en km de la estación meteorológica.

- \texttt{mes}: Mes en el que se tomó la medición.

- \texttt{teprom}: Temperatura promedio medida a lo largo de diversos años.

- \texttt{precipprom}: Precipitación promedio medida a lo largo de diversos años.

- \texttt{precipmin}: Precipitación mínima medida a lo largo de diversos años.

- \texttt{precipmax}: Precipitación máxima medida a lo largo de diversos años.

- \texttt{elev}: Elevación en la que se ubica la estación meteorológica.

El **objetivo** es predecir **por mes** las variables \texttt{precipprom}, \texttt{precipmin} y \texttt{precipmax} en todo el siguiente mapa. A continuación mostramos las estaciones meteorológicas y la retícula de apoyo donde vamos a hacer un análisis predictivo de las variables antes mencionadas.

\vspace{-0.45cm}

```{r,out.width='80%',fig.align='center'}
#CREAMOS LA RETICULA
res <- 50
grid <- expand.grid(longitud=seq(min(contorno$longitud), max(contorno$longitud), res), 
                    latitud=seq(min(contorno$latitud), max(contorno$latitud), res))
#Gráfica de la retícula y los datos observados
plot(grid[,1:2], pch=".",asp=1,
     main="Ubicación de las estaciones meteorológicas y retícula",
     xlab="Kilómetros 'x'",ylab="Kilómetros 'y'")
points(lluvia$longitud, lluvia$latitud, col = 2, pch ="+")
points(contorno$longitud, contorno$latitud, pch = ".")
legend("topright", legend=c("Estaciones", "Retícula"),
       col=c("red", "black"), pch=c("+","."), cex=0.8)
```

\vspace{-1cm}

\newpage




# 2. Metodología

En este apartado vamos a describir lo que haremos para poder pronosticar cada una de las variables antes mencionadas. A continuación mostramos el procedimiento que seguiremos.

1. Análisis exploratorio de los datos: Comenzamos describiendo el comportamiento de la tabla de datos con la que estamos trabajando. Aquí buscaremos particularmente la influencia que tienen los meses sobre las variables explicativas y respuestas.

2. Definir la retícula de estimación: Esto lo vimos visualmente en la sección anterior, es donde vamos a pronosticar con base en las observaciones realizadas por las estaciones meteorológicas. Aquí vale la pena hacer la observación de que la coordenada (0,0) es un punto en el océano pacífico.

*Nota*: Las coordenadas serán procesadas con la función \texttt{jitterDupCoords} pues hay estaciones meteorológicas que se encuentran muy cercanas una de otras.

3. Kriging de Elevación: Este es un punto que es independiente de cada mes pues la elevación de las estaciones meteorológicas no cambia con base en el mes, aquí buscaremos estimar la elevación de las zonas aledañas a las estaciones con base en la retícula.

**A partir del siguiente punto, los resultados se mostrarán por mes**.

4. Kriging de Temperatura: Análogo al inciso 3, aquí buscaremos predecir la temperatura en la retícula.

5. Modelo lineal sobre las estaciones observadas en función de elevación y temperatura: Planteamos un modelo lineal que involucre la variable respuesta que se esté trabajando (ya sea \texttt{precipprom}, \texttt{precipmin} o \texttt{precipmax}) y las variables explicativas, en este caso elevación y temperatura, en particular de aquí nos va a interesar los residuales.

*Nota*: La variable respuesta se busca que sea al menos no-negativa, por lo que se le aplica en cada caso logaritmo al momento de realizar el modelo lineal, y en el caso de contener ceros se le suma una cantidad pequeña par no obtener indeterminaciones.

6. Kriging de residuales del modelo lineal anterior: Aquí buscaremos predecir el valor de los residuales del modelo en la retícula.

7. Evaluación del modelo lineal para cada punto de la retícula: Con base en los coeficientes del modelo lineal y los residuales obtenidos con su kriging, a cada punto de la retícula le calculamos su valor predicho con el modelo lineal.

8. Representación gráfica de las estimaciones del punto anterior: Finalmente mostramos un gráfico que nos permita observar el comportamiento de la variable respuesta en el mapa de la zona geográfica que estamos manipulando.

*Nota*: Es importante destacar que para la implementación de los kriging es necesario establecer un modelo a partir de un variograma, el cuál fue construido en todos los casos con un modelo de covarianza gaussiano.

En caso de ser necesario, realizaremos gráficos y tablas de datos para mostrar los comportamientos de los modelos, ya sea para ver los variogramas de los mismos, de los cuales también estaremos mostrando sus parámetros; los parámetros de los modelos de regresión así como su significancia y los mapas de predicción que nos arrojan cada modelo, mostrando también los mapas de las predicciones realizadas por los krigings y su respectiva varianza.

Otro punto importante qué comentar con respecto a la metodología es la existencia de ceros en la información. Por ejemplo, la variable respuesta referente a la precipitación mínima para ciertos meses consistía de observaciones que eran únicamente cero, y en el caso de Diciembre tenía únicamente dos observaciones diferente de cero. Para estos casos, la predicción numérica no fue posible, debido a que la respuesta consistía en muchos valores nulos, algo que intuitivamente se puede resolver, debido a que podemos asumir que el mapa a predecir debe ser una constante igual a cero, pues no hay factores que hagan que la respuesta sea diferente a este resultado. 

En particular, de lo comentado en la sección anterior notamos que los datos que tenemos son del tipo longitudinal, esto es que vienen mediciones a lo largo del tiempo (meses) de las estaciones meteorológicas. Para propósitos de este trabajo, vamos a trabajar a cada mes de forma independiente. Esto implica que ciertos puntos se harán en general y servirán para todos los meses (primer tipo), mientras que otros se deben ver a detalle para cada mes en particular (segundo tipo). Los puntos 2 y 3 son del primer tipo pues se trabaja con variables y entidades que no dependen del mes en el que se encuentra. Por otro lado, los puntos 1 y del 4 al 8 son del segundo tipo, pues sí pueden variar dependiendo del mes en el que se encuentra.




# 3. Análisis Exploratorio

## 3.1 Gráficos dos a dos

Lo siguiente es una representación gráfica del comportamiento directo por coordenadas de las variables explicativas y respuesta separadas por colores que representan a los meses del 1 (Enero) al 12 (Diciembre).

```{r, out.width='100%'}
#Gráficas dos a dos
# Correlation panel
panel.cor <- function(x, y){
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  r <- round(cor(x, y), digits=2)
  txt <- paste0("R = ", r)
  cex.cor <- 0.8/strwidth(txt)
  text(0.5, 0.5, txt, cex = 1)
}
# Customize upper panel
upper.panel<-function(x, y){
  points(x,y, pch = 19, col = rainbow(13)[lluvia$mes])
}
pairs(lluvia %>% dplyr::select(elev,mes,teprom,precipmin,precipprom,precipmax),
      upper.panel = upper.panel,
      lower.panel=panel.cor)
#de aqui se puede concluir que para los meses 6-10
#la temperatura promedio, el promedio de precipitaciones,
#la precipitación mínima y máxima, son mayores que los del resto del año

#También se puede ver que mientras más al este mayor valor de las variables
#antes mencionadas.
```

De aquí podemos apreciar que los meses 6-10 presentan un comportamiento diferente al resto del año en términos de temperatura promedio y precipitación. De igual manera, vemos una relación lógica de correlación entre las estadísticas de precipitación que estamos trabajando.


\newpage


## 3.2 Histogramas

En este apartado vamos a separar por mes el comportamiento distribucional de las variables que tomamos anteriormente. De nuevo, nuestro objetivo es darnos una idea de cómo se comportan las respuestas dependiendo de cada mes. En esta sección, variables de geolocalización no serán contempladas pues de hecho no dependen de cada mes. 

Dos notas importantes, (1)  algunas de las variables serán trasnformadas con la función $f(x)=log(x+0.1)$ con la finalidad de dar una mejor visualización de este comportamiento distribucional y (2) notemos que las escalas de los ejes en los histogramas que veremos a continuación se mantienen con la finalidad de hacer los gráficos comparables.

```{r}
# Histogramas divididos por mes ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
library(ggplot2)
meses <- c("Enero","Febrero","Marzo","Abril",
           "Mayo","Junio","Julio","Agosto",
           "Septiembre","Octubre","Novimebre","Diciembre")
meses <- factor(x = meses,levels = meses,ordered = TRUE)
```

```{r,out.width='60%'}
# Temperatura promedio ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ggplot(lluvia, aes(x = teprom)) +
  geom_histogram(aes(color = meses[mes], 
                     fill = meses[mes],
                     # Con esto cambiamos el eje 'y'.
                     y=..density..), 
                 position = "identity", bins = 15, alpha = 0.4) +
  # Colores de contorno y relleno
  scale_color_manual(values = viridis::viridis(12)) +
  scale_fill_manual(values = viridis::viridis(12)) +
  # Con esto graficamos por mes.
  facet_wrap(~meses[mes]) +
  # Omitimos la leyenda innecesaria
  theme(legend.position = "none") +
  labs(title=paste("Temperatura Promedio"),y ="",x="", 
       color="Mes",fill = "Mes")
```

Esta es una variable explicativa que en general puede tomar valores en los reales. De aquí podemos ver que en los meses de Mayo-Octubre se conserva una temperatura más alta con respecto al resto de los meses, donde podemos ver la disminución en la temperatura de los meses de Noviembre-Febrero (algo que se puede verificar por la posición geográfica en la que se encuentra el autor y a tiempos en los que se escribe este reporte), y se mantienen medios en los meses de Marzo y Abril. 

El resto de los gráficos son ya correspondientes a las variables respuesta de las cuales queremos obtener un mapa con la metodología antes exhibida.

```{r,out.width='60%'}
# Precipitación promedio ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ggplot(lluvia, aes(x = precipprom)) +
  geom_histogram(aes(color = meses[mes], 
                     fill = meses[mes],
                     # Con esto cambiamos el eje 'y'.
                     y=..density..), 
                 position = "identity", bins = 15, alpha = 0.4) +
  # Colores de contorno y relleno
  scale_color_manual(values = viridis::viridis(12)) +
  scale_fill_manual(values = viridis::viridis(12)) +
  # Con esto graficamos por mes.
  facet_wrap(~meses[mes]) +
  # Omitimos la leyenda innecesaria
  theme(legend.position = "none") +
  labs(title=paste("Precipitación Promedio"),y ="",x="", 
       color="Mes",fill = "Mes")
```

En este gráfico destacan los meses de Junio a Octubre, donde vemos que hay un aumento en la precipitación. Esto concuerda con el conocimiento empírico que tenemos sobre "los meses lluviosos".

```{r,out.width='80%'}
# Usando logaritmos 'para ver mejor'
ggplot(lluvia, aes(x = precipprom + 0.1 %>% log())) +
  geom_histogram(aes(color = meses[mes], 
                     fill = meses[mes],
                     # Con esto cambiamos el eje 'y'.
                     y=..density..), 
                 position = "identity", bins = 15, alpha = 0.4) +
  # Colores de contorno y relleno
  scale_color_manual(values = viridis::viridis(12)) +
  scale_fill_manual(values = viridis::viridis(12)) +
  # Con esto graficamos por mes.
  facet_wrap(~meses[mes]) +
  # Omitimos la leyenda innecesaria
  theme(legend.position = "none") +
  labs(title=paste("Log - Precipitación Promedio"),y ="",x="", 
       color="Mes",fill = "Mes")
```

Con respecto al gráfico anterior, en este mostramos la distribución delos datos transformados con la función $f$. Donde en esencia se percibe el mismo comportamiento que el descrito anteriormente.

```{r,out.width='80%'}
# Precipitación Mínima ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ggplot(lluvia, aes(x = precipmin)) +
  geom_histogram(aes(color = meses[mes], 
                     fill = meses[mes],
                     # Con esto cambiamos el eje 'y'.
                     y=..density..), 
                 position = "identity", bins = 15, alpha = 0.4) +
  # Colores de contorno y relleno
  scale_color_manual(values = viridis::viridis(12)) +
  scale_fill_manual(values = viridis::viridis(12)) +
# Con esto graficamos por mes.
facet_wrap(~meses[mes]) +
  # Omitimos la leyenda innecesaria
  theme(legend.position = "none") +
  labs(title=paste("Precipitación Mínima"),y ="",x="", 
       color="Mes",fill = "Mes")
```

En estos histogramas destacamos que para la mayoría de los meses la precipitación mínima en los registros resultó ser prácticamente cero, salvo en algunos de los meses que catalogamos como "más lluviosos" donde parece tener una distribución con colas más pesadas, aunque en general tienen una concentración en el cero.

```{r,out.width='80%'}
# Usando logaritmos 'para ver mejor'
ggplot(lluvia, aes(x = precipmin+0.1 %>% log())) +
  geom_histogram(aes(color = meses[mes], 
                     fill = meses[mes],
                     # Con esto cambiamos el eje 'y'.
                     y=..density..), 
                 position = "identity", bins = 15, alpha = 0.4) +
  # Colores de contorno y relleno
  scale_color_manual(values = viridis::viridis(12)) +
  scale_fill_manual(values = viridis::viridis(12)) +
  # Con esto graficamos por mes.
  facet_wrap(~meses[mes]) +
  # Omitimos la leyenda innecesaria
  theme(legend.position = "none") +
  labs(title=paste("Log - Precipitación Mínima"),y ="",x="", 
       color="Mes",fill = "Mes")
```

Con respecto al gráfico anterior, en este mostramos la distribución delos datos transformados con la función $f$. Donde en esencia se percibe el mismo comportamiento que el descrito anteriormente.


```{r,out.width='80%'}
# Precipitación Máxima ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
ggplot(lluvia, aes(x = precipmax)) +
  geom_histogram(aes(color = meses[mes], 
                     fill = meses[mes],
                     # Con esto cambiamos el eje 'y'.
                     y=..density..), 
                 position = "identity", bins = 15, alpha = 0.4) +
  # Colores de contorno y relleno
  scale_color_manual(values = viridis::viridis(12)) +
  scale_fill_manual(values = viridis::viridis(12)) +
  # Con esto graficamos por mes.
  facet_wrap(~meses[mes]) +
  # Omitimos la leyenda innecesaria
  theme(legend.position = "none") +
  labs(title=paste("Precipitación Máxima"),y ="",x="", 
       color="Mes",fill = "Mes")
```

El comportamiento distribucional del máximo resulta ser muy interesante, pues incluso parece que hay meses donde algunas estaciones meteorológicas no tuvieron precipitaciones. Esto influye muchísimo en el resto de los datos pues que las precipitaciones máximas sean cero significa que el promedio y el mínimo también lo son, en los meses que se muestran como "lluviosos" la distribución del máximo podría ser similar al de una Gamma, esto no es del todo sorprendente pues únicamente reafirma la presencia recurrente de lluvias en esos meses.

```{r,out.width='80%'}
# Usando logaritmos 'para ver mejor'
ggplot(lluvia, aes(x = precipmax + 0.1 %>% log())) +
  geom_histogram(aes(color = meses[mes], 
                     fill = meses[mes],
                     # Con esto cambiamos el eje 'y'.
                     y=..density..), 
                 position = "identity", bins = 15, alpha = 0.4) +
  # Colores de contorno y relleno
  scale_color_manual(values = viridis::viridis(12)) +
  scale_fill_manual(values = viridis::viridis(12)) +
  # Con esto graficamos por mes.
  facet_wrap(~meses[mes]) +
  # Omitimos la leyenda innecesaria
  theme(legend.position = "none") +
  labs(title=paste("Log - Precipitación Máxima"),y ="",x="", 
       color="Mes",fill = "Mes")
```

Con respecto al gráfico anterior, en este mostramos la distribución delos datos transformados con la función $f$. Donde en esencia se percibe el mismo comportamiento que el descrito anteriormente.


\newpage






# 4. Modelación

```{r}
###HACEMOS JITTER (observese que sin pérdida de generalidad lo hacemos para el mes de enero)
lluvia_jit <- jitterDupCoords(lluvia_mes[,1:2],max=.01)
```

## 4.1 Elevación

```{r,results='hide'}
###KRIGING DE ELEVACION (observese que sin pérdida de generalidad lo hacemos para el mes de enero)
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$elev))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Elevación"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit elev."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid[,1:2],krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de elevación en la retícula
grid$elev <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
mynamestheme <- theme(plot.title = element_text(family = "Helvetica", face = "bold", size = (10)), 
                      legend.title = element_text(colour = "steelblue",  face = "bold.italic", family = "Helvetica"), 
                      legend.text = element_text(face = "italic", colour="steelblue4",family = "Helvetica"), 
                      axis.title = element_text(family = "Helvetica", size = (10), colour = "steelblue4"),
                      axis.text = element_text(family = "Courier", colour = "cornflowerblue", size = (10)))
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud),
                                    colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",
                                    size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = "Elevación estimada", fill="Elevación")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), 
                                  colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",
                                  size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = "Varianza de la estimación", fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De los mapas anteriores se concluye lo siguiente:

* Es fácil observar que en las zonas costeras y en el mar se tiene menor elevación que en la parte noreste del mapa, esto tiene todo sentido, ya que México es un país que en general se encuentra arriba del nivel del mar.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa. **Este fenómeno se puede apreciar en todos los gráficos de mapas de varianza de los kriging, de tal manera que no se comentará en los restantes, el lector podrá percibir por sí mismo que esto sucede en cada ocasión. Debido a esto, las predicciones que caen en estas zonas son las más imprecisas.**

\newpage



## 4.2 Análisis por mes

### 4.2.1 Enero

```{r}
n_mes <- "Enero"
lluvia_mes = lluvia %>% dplyr::filter(mes==1)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (casi de 20°C en toda la retícula), a excepción de la región noreste, aunque vemos que justo en esta zona parece que la predicción tiene una varianza relativamente alta.


\newpage

#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

Es importante comentar que la variable \texttt{teprom} no es significativa en el modelo (por su p-value), es decir, no se rechaza la hipótesis de que su coeficiente es cero, lo que implica que realmente no sirve para describir el valor de la precipitación promedio, sin embargo, se decidió dejarla en modelo puesto que su coeficiente es, de hecho, casi cero. Por otro lado, la variable \texttt{elev} parece estar explicando el modelo aunque su coeficiente de hecho está cercano a cero.

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error mucho más grande.

* Notemos que los errores parecen no tener valores sumamente grandes, esto es también considerando que se está modelando una transformación de la respuesta.

#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En los estados de Baja California Norte, Sonora y Sinaloa, en promedio, llueve más.

* En Baja California Sur y en la zona costera entre Sonora y Sinaloa, en promedio, llueve menos.

*Nota*: Para todos estos gráficos no debemos perder de vista la escala de los colores.

#### Modelo lineal de precipitación mínima

```{r}
###MODELO LINEAL PRECIPITACIÓN MÍNIMA
precipmin_ml <- lm (log(precipmin+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmin_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

$$
log(\text{\texttt{precipmin}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación mínima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Nótese que el coeficiente de \texttt{elev} resulta no significativo (por el valor de p-value), sin embargo, se decidió no quitar la variable porque el valor del coeficiente es prácticamente cero. También podemos concluir que a mayor temperatura, menor será el valor mínimo de la precipitación pues tiene coeficiente negativo, aunque de igual manera este efecto es bajo debido a la magnitud del coeficiente.

```{r,results='hide'}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmin_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación mínima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>%  round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmin (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación mínima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De los mapas se concluye:

* En general, los residuales tiene valor de casi cero en todo el mapa, recordemos que el efecto de los colores es para lograr identificar diferencias significativas entre los puntos del mapa pero en general el resultado a efectos prácticos es el ya mencionado.

#### Estimación de precipitación mínima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmin}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)-0.1
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÍNIMA
grid$precipmin <- exp(predict(precipmin_ml,grid[,c("teprom","elev")]) + grid$error)-0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmin))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación mínima estimada (",n_mes,")"), fill="Precipitación mínima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Observando la escala, la precipitación mínima estimada es prácticamente, cero en todo el mapa. Este resultado tiene sentido porque si se observan los valores que toma \texttt{precipmin} en la base de datos son, en su mayoría, puro cero.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Tanto el coeficiente de \texttt{teprom} como el de \texttt{elev} resultan no significativos en el modelo (por su p-value), sin embargo, se dejaron puesto que sus coeficientes valen, prácticamente cero.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Precipitación máxima tiene un error mucho menor que las estimaciones anteriores, sin embargo, observamos mayor error en las zonas alejadas a los datos.

* En este mapa se puede apreciar un error positivo en la región noreste y negativo en la región suroeste, sin perder de vista que aquí es donde tenemos más volatilidad.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano y en la península se observan los valores más altos de precipitación máxima.

* En la zona costera de Sonora y Sinaloa disminuye la precipitación máxima.

* En la zona noreste del mapa se tienen los valores más bajos de precipitación máxima, por otro lado en la región noreste parece haber una precipitación menor. Aunque de nuevo, estos extremos siempre son los que tenían más volatilidad.

\newpage

### 4.2.2 Febrero

```{r}
n_mes <- "Febrero"
lluvia_mes = lluvia %>% dplyr::filter(mes==2)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general el mapa presenta una temperatura templada con respecto al mínimo y máximo, alrededor de los 16°C.

* Uno de las zonas con mayor temperatura es en Sinaloa, mientras que en Sonora por la frontera con USA parece haber una temperatura menor, aunque de nuevo esta es una zona con volatilidad como podemos ver en el mapa de la varianza.

#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí ambas variables resultan ser significativas, sin embargo sus coeficientes al estar cercanos a cero no presentarán una gran influencia en el modelo, en el caso de la temperatura, vemos que hay una relación lineal negativa con la respuesta, caso contrario para la elevación.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error mucho más grande.

#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En los estados de Baja California Norte, Sonora y Sinaloa, en promedio, llueve más.

* En Baja California Sur y en la zona costera entre Sonora y Sinaloa, en promedio, llueve menos.

* En este mes parece haber una precipitación promedio más alta en la zona central del país.

#### Modelo lineal de precipitación mínima

Notemos que para este mes, la variable $y_\texttt{precipmin}$ tiene la siguiente propiedad

$$
\text{máx}\{y_\texttt{precipmin}\}= `r max(lluvia_mes$precipmin)`
$$

Entonces, la predicción de esta variable debe ser cero en todo el mapa.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Tanto el coeficiente de \texttt{teprom} como el de \texttt{elev} resultan ser significativos en el modelo (por su p-value). Aunque de nuevo, los coeficientes tienen una magnitud pequeña. Podemos ver que al menos para este mes dela año, en general la temperatura parece mantener una relación lineal negativa con la respuesa.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, parece que el mapa no presenta errores muy grandes, curiosamente la zona que tiene un error positivo más grande es una donde sí se encuentran estaciones meteorológicas, al noroeste de baja california norte.


#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano y en la península se observan los valores más bajos de precipitación máxima.

* En la zona costera de Sonora y Sinaloa aumenta la precipitación máxima.

* En la zona noroeste del mapa se tienen los valores más altos de precipitación máxima.

\newpage

### 4.2.3 Marzo

```{r}
n_mes <- "Marzo"
lluvia_mes = lluvia %>% dplyr::filter(mes==3)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (casi de 20°C en toda la retícula).

#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Lo primero que observamos es que aquí los coeficientes en el modelo parecen ser significativos, ahora vemos un coeficiente especialmente alto para la temperatura, el cual resulta ser negativo y por ende implica que hay una relación lineal negativa con la variable respuesta.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general la estimación presenta un error positivo aunque no muy grande.

* En donde parece haber errores más significativos son en las zonas noroeste, este y suroeste del mapa. En esta última, es la única región donde el error parece predecirse de forma negativa.


#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En los estados de Baja California Norte, Sonora y Sinaloa, en promedio, llueve más.

* En Baja California Sur y en la zona costera entre Sonora y Sinaloa, en promedio, llueve menos.

* La zona con más precipitación promedio parece presentarse al noreste del mapa, en esta misma dirección de baja california norte.

#### Modelo lineal de precipitación mínima

Notemos que para este mes, la variable $y_\texttt{precipmin}$ tiene la siguiente propiedad

$$
\text{máx}\{y_\texttt{precipmin}\}= `r max(lluvia_mes$precipmin)`
$$

Entonces, la predicción de esta variable debe ser cero en todo el mapa.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Tanto el coeficiente de \texttt{teprom} como el de \texttt{elev} resultan ser significativos en el modelo (por su p-value).


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Precipitación máxima tiene un error mucho menor que las estimaciones anteriores, sin embargo, observamos mayor error en las zonas alejadas a los datos, en particular a los extremos oeste, este y sur.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano y en la península se observan los valores más bajos de precipitación máxima.

* En la zona costera de Sonora y Sinaloa aumenta levemente la precipitación máxima.

* En la zona noroeste del mapa se tienen los valores más altos de precipitación máxima.

\newpage

### 4.2.4 Abril

```{r}
n_mes <- "Abril"
lluvia_mes = lluvia %>% dplyr::filter(mes==4)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Con respecto a los meses anteriores parece que la temperatura promedio ha aumentado.

* En particular notamos un aumento considerable en el estado de Sinaloa.

* Por otro lado, en la parte norte de Baja California parece que mostrar la temperatura más baja de la zona.

#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Es importante comentar que la variable \texttt{teprom} no es significativa en el modelo (por su p-value), es decir, no se rechaza la hipótesis de que su coeficiente es cero, lo que implica que realmente no sirve para describir el valor de la precipitación promedio, sin embargo, se decidió dejarla en modelo puesto que su coeficiente es, de hecho, casi cero. Por otro lado la variable correspondiente a la elevación sí es significativa, pero su coeficiente también parece aportar poco al modelo.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error mucho más grande, principalmente al suroeste del mapa y al norte de Baja California.

#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right) - 0.1
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error) - 0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En este mes del año parece no haber mucha precipitación promedio. De hecho la mayoría de las zonas observadas reportan tener una precipitación promedio bastante baja.

* En particular, notamos que al centro de Sonora y al norte de Baja California parece aumentar un poco más la precipitación en este mes con respecto a las demás zonas.

#### Modelo lineal de precipitación mínima

Notemos que para este mes, la variable $y_\texttt{precipmin}$ tiene la siguiente propiedad

$$
\text{máx}\{y_\texttt{precipmin}\}= `r max(lluvia_mes$precipmin)`
$$

Entonces, la predicción de esta variable debe ser cero en todo el mapa.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí la temperatura parece no ser significativa, y por otro lado la elevación sí, aunque ambos tienen coeficiente cercano a cero.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, parece que el error se hace más grande en terminos de magnitud tanto al norte como al sur del mapa.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right) - 0.1
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error) - 0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano, en la península y en general en la costa de los estados estudiados se observan los valores más bajos de precipitación máxima en este mes.

* Al centro de Sonora parece que hay una mayor precipitación máxima en este mes.

\newpage

### 4.2.5 Mayo

```{r}
n_mes <- "Mayo"
lluvia_mes = lluvia %>% dplyr::filter(mes==5)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Vemos que existe un aumento de temperatura en la zona este del mapa durante estos meses, alcanzando una temperatura promedio de hasta 27°C

* Por otro lado hay una temperatura menor al oeste del mapa, teniendo una temperatura promedio de hasta 15°C.

#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Es importante comentar que la variable \texttt{teprom} no es significativa en el modelo (por su p-value), es decir, no se rechaza la hipótesis de que su coeficiente es cero, lo que implica que realmente no sirve para describir el valor de la precipitación promedio, sin embargo, se decidió dejarla en modelo puesto que su coeficiente es, de hecho, casi cero. Nuevamente la elevación tiene un coeficiente cercano a cero pero sí es significativa.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error mucho más grande.


#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right) - 0.1
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error) - 0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En los estados de Sonora y Sinaloa, en promedio, llueve más en su zona oeste.

* En Baja California y en la zona costera entre Sonora y Sinaloa, en promedio, llueve menos.

#### Modelo lineal de precipitación mínima

Notemos que para este mes, la variable $y_\texttt{precipmin}$ tiene la siguiente propiedad

$$
\text{máx}\{y_\texttt{precipmin}\}= `r max(lluvia_mes$precipmin)`
$$

Entonces, la predicción de esta variable debe ser cero en todo el mapa.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí sucede un comportamiento muy análogo con respecto a los coeficientes del modelo para la precipitación promedio.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='85%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Parece que los errores son un cero numérico y la varianza es constante no muy alejada de la unidad en todo el mapa. De tal manera que no hay un error geográfico importante en este modelo.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right) - 0.1
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error) - 0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano y en la península se observan los valores más bajos de precipitación máxima.

* En la zona costera de Sonora y Sinaloa aumenta la precipitación máxima.

* En la zona centro de los estados anteriores se tienen los valores más altos de precipitación máxima.

\newpage

### 4.2.6 Junio

```{r}
n_mes <- "Junio"
lluvia_mes = lluvia %>% dplyr::filter(mes==6)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (casi de 30°C en toda la retícula), a excepción de la región suroeste, pero aquí recordemos que hay una volatilidad muy alta.

* Las zonas que no tienen tanta temperatura promedio son las que se encuentran en la península o bien en la costa.


#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí los resultados son muy interesantes, a diferencia de meses pasados, aquí vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación promedio. Recordemos que en los últimos meses la temperatura promedio estimada ha aumentado considerablemente.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Aquí vemos que hay un error más concentrado tanto en la zona este como oeste principalmente del mapa.

* Al centro parece haber un error más pequeño.


#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)-0.1
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)-0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En las zonas costeras y aledañas a la península, la precipitación promedio es sumamente baja.

* La precipitación promedio en este mes es sumamente alta para las zonas centro de Sonora y Sinaloa.

#### Modelo lineal de precipitación mínima

```{r}
###MODELO LINEAL PRECIPITACIÓN MÍNIMA
precipmin_ml <- lm (log(precipmin+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmin_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

$$
log(\text{\texttt{precipmin}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t(), "latex", caption = paste0("Coeficientes de log-precipitación mínima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Nótese que el coeficiente de \texttt{teprom} resulta no significativo (por el valor de p-value), sin embargo, se decidió no quitar la variable porque el valor del coeficiente es prácticamente cero. También podemos concluir que a mayor temperatura, menor será el valor mínimo de la precipitación pues tiene coeficiente negativo.

```{r,results='hide'}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmin_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación mínima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>%  round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmin (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación mínima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De los mapas se concluye:

* En general el error estimado de precipitación máxima puede ser significativamente grande.

* Hay una volatilidad sumamente alta en las zonas alejadas de las observaciones.


#### Estimación de precipitación mínima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmin}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)-0.1
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÍNIMA
grid$precipmin <- exp(predict(precipmin_ml,grid[,c("teprom","elev")]) + grid$error)-0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmin))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación mínima estimada (",n_mes,")"), fill="Precipitación mínima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Observando la escala, la precipitación mínima estimada es prácticamente, cero en todo el mapa. **Salvo en la zona centro de Sinaloa y Sonora**, aquí, al contrario, se estima una precipitación mínima sumamente alta.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Tanto el coeficiente de \texttt{teprom} como el de \texttt{elev} resultan ser significativos en el modelo (por su p-value), de hecho nuevamente vemos que hay una relación positiva considerable con la variable respuesta y la temperatura promedio.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general el error estimado de precipitación máxima puede ser significativamente grande.

* Hay una volatilidad sumamente alta en las zonas alejadas de las observaciones.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)-0.1
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)-0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano y en la península se observan los valores más altos de precipitación máxima.

* En las zonas costeras y aledañas a la península, la precipitación máxima es sumamente baja.

* La precipitación máxima en este mes es sumamente alta para las zonas centro de Sonora y Sinaloa.

\newpage

### 4.2.7 Julio

```{r}
n_mes <- "Julio"
lluvia_mes = lluvia %>% dplyr::filter(mes==7)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (casi de 30°C en toda la retícula) y esta vez es aún más consistente que en el mes pasado.

#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación promedio. Recordemos que en los primeros meses la temperatura promedio estimada ha aumentado considerablemente.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error más grande.

#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En los estados de Sonora y Sinaloa en su zona centro, en promedio, llueve más y de hecho es aún más alto que el mes pasado.

* En Baja California y en la zona costera entre Sonora y Sinaloa, en promedio, llueve menos.

#### Modelo lineal de precipitación mínima

```{r}
###MODELO LINEAL PRECIPITACIÓN MÍNIMA
precipmin_ml <- lm (log(precipmin+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmin_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

$$
log(\text{\texttt{precipmin}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación mínima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación mínima.

```{r,results='hide'}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmin_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación mínima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>%  round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmin (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación mínima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De los mapas se concluye:

* En general, los residuales tiene valor de casi cero en todo el mapa.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa.


#### Estimación de precipitación mínima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmin}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)-0.1
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÍNIMA
grid$precipmin <- exp(predict(precipmin_ml,grid[,c("teprom","elev")]) + grid$error)-0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmin))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación mínima estimada (",n_mes,")"), fill="Precipitación mínima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Observando la escala, la precipitación mínima estimada es prácticamente, cero en todo el mapa. Este resultado tiene sentido porque si se observan los valores que toma \texttt{precipmin} en la base de datos son, en su mayoría, puro cero.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación máxima.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Precipitación máxima tiene un error mucho menor que las estimaciones anteriores, sin embargo, observamos mayor error en las zonas noroeste y sureste.


#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano y en la península se observan los valores más bajos de precipitación máxima.

* En la zona costera de Sonora y Sinaloa aumenta la precipitación máxima.

* En la zona centro de Sonora y Sinaloa parece que hay precipitaciones máximas estimadas muy altas.

\newpage


### 4.2.8 Agosto

```{r}
n_mes <- "Agosto"
lluvia_mes = lluvia %>% dplyr::filter(mes==8)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (casi de 27°C en toda la retícula), a excepción de la región suroeste.


#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación promedio.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Vemos que en general los errores parecen estables en términos de varianza y no significativamente grandes.


#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En los estados de Baja California en promedio llueve menos.

* Fuera de las zonas antes mencionadas la precipitación promedio es realmente alta.

#### Modelo lineal de precipitación mínima

```{r}
###MODELO LINEAL PRECIPITACIÓN MÍNIMA
precipmin_ml <- lm (log(precipmin+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmin_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

$$
log(\text{\texttt{precipmin}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación mínima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación mínima.

```{r,results='hide'}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmin_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación mínima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>%  round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmin (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación mínima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De los mapas se concluye:

* En general, los residuales tiene valor de casi cero en todo el mapa.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa.


#### Estimación de precipitación mínima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmin}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)-0.1
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÍNIMA
grid$precipmin <- exp(predict(precipmin_ml,grid[,c("teprom","elev")]) + grid$error)-0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmin))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación mínima estimada (",n_mes,")"), fill="Precipitación mínima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Observando la escala, la precipitación mínima estimada es prácticamente, cero en todo el mapa **salvo en la zona centro de los estados de Sinaloa y Sonora** donde vemos una precipitación mínima considerablemente alta en este mes.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación máxima.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Precipitación mácima tiene un error mucho menor que las estimaciones anteriores, sin embargo, observamos mayor error en las zonas alejadas a los datos.

* En la zona cercana a las estaciones observadas se tiene menor vairanza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano y en la península se observan los valores más bajos de precipitación máxima.

* En la zona costera de Sonora y Sinaloa aumenta la precipitación máxima.

* En la zona sureste del mapa se tienen los valores más altos de precipitación máxima.

\newpage

### 4.2.9 Septiembre

```{r}
n_mes <- "Septiembre"
lluvia_mes = lluvia %>% dplyr::filter(mes==9)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (de  más de 25°C en toda la retícula), a excepción de la región suroeste.


#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación promedio.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error mucho más grande.

* La volatilidad en este mapa es bastante pequeña.

#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En los estados de Baja California en promedio llueve menos.

* Fuera de la zona antes mencionada en promedio la pricipitación promedio es mayor.

#### Modelo lineal de precipitación mínima

```{r}
###MODELO LINEAL PRECIPITACIÓN MÍNIMA
precipmin_ml <- lm (log(precipmin+0.1) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmin_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

$$
log(\text{\texttt{precipmin}}+0.1) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación mínima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación mínima.

```{r,results='hide'}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmin_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación mínima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>%  round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmin (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación mínima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De los mapas se concluye:

* En general, los residuales tiene valor de casi cero en todo el mapa, salvo regiones específicas.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa y donde se presenta una volatilidad considerablemente alta.


#### Estimación de precipitación mínima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmin}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)-0.1
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÍNIMA
grid$precipmin <- exp(predict(precipmin_ml,grid[,c("teprom","elev")]) + grid$error)-0.1

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmin))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación mínima estimada (",n_mes,")"), fill="Precipitación mínima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Observando la escala, la precipitación mínima estimada es prácticamente, cero en todo el mapa. **Salvo en la zona centro de Sinaloa**.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación máxima.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Precipitación máxima tiene un error mucho menor que las estimaciones anteriores, sin embargo, observamos mayor error en las zonas alejadas a los datos.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa, aunque ésta no es tan grande en este caso.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En la zona del océano y en la península se observan los valores más bajos de precipitación máxima, salvo en la zona sur de Baja California.

* En la zona costera de Sonora y Sinaloa aumenta la precipitación máxima.

* En la zona sureste del mapa se tienen los valores más altos de precipitación máxima.

\newpage

### 4.2.10 Octubre

```{r}
n_mes <- "Octubre"
lluvia_mes = lluvia %>% dplyr::filter(mes==10)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (de más de 24°C en casi toda la retícula), a excepción de la región suroeste y noreste.


#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación promedio.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error mucho más grande.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa, aunque con una magnitud baja.


#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* En el océano se tiene menor precipitación promedio, lo que de hecho puede no ser cierto pues es una zona que tenía mucha varianza en la predicción y además es muy alejada de los puntos observados.

* En los estados de Sonora y Sinaloa, en promedio, llueve más.

* En Baja California y en la zona costera entre Sonora, en promedio, llueve menos.

#### Modelo lineal de precipitación mínima \newline

Notemos que para este mes, la variable $y_\texttt{precipmin}$ tiene la siguiente propiedad

$$
\text{máx}\{y_\texttt{precipmin}\}= `r max(lluvia_mes$precipmin)`
$$

Entonces, la predicción de esta variable debe ser cero en todo el mapa.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación máxima.

```{r,results='hide',out.width='50%'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* El error en la precipitación máxima es prácticamente cero e igual en todo el mapa.

* La volatilidad del error es considerablemente baja e igual en todo el mapa.

* Para los residuales, parece no haber un efecto geográfico que afecte la precipitación máxima.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* Prácticamente en toda la zona de tierra y en el golfo parece haber precipitación máxima considerablemente alta.

* En el mar por la coordenada origen, parece no haber mucha precipitación máxima.

* En el estado de Sinaloa parece que hay la precipitación máxima más alta.

\newpage


### 4.2.11 Noviembre

```{r}
n_mes <- "Noviembre"
lluvia_mes = lluvia %>% dplyr::filter(mes==11)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (casi de 20°C en toda la retícula), a excepción de la región noreste.

* Notemos que aquí el comportamiento vuelve a ser como era con los primeros meses.

#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación promedio. Aunque a diferencia de los últimos meses, el p-value de la temperatura es de hecho a penas significativo, teniendo un criterio un poco menos riguroso.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error mucho más grande.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa. Nuevamente la magnitud de la varianza es baja.


#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* Este mapa parece que tiene la variedad de zonas con precipitación más distribuida de todos los anteriores.

* Vamos que en Baja California norte hay una sección con precipitación promedio alta, pero en general, la península destaca por tener una precipitación promedio baja.

* En la zona centro de Sinaloa y Sonora parece que suele haber una precipitación promedio más alta.

#### Modelo lineal de precipitación mínima \newline

Notemos que para este mes, la variable $y_\texttt{precipmin}$ tiene la siguiente propiedad

$$
\text{máx}\{y_\texttt{precipmin}\}= `r max(lluvia_mes$precipmin)`
$$

Entonces, la predicción de esta variable debe ser cero en todo el mapa.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí nuevamente vemos que ambas variables son significativas y más aún, la variable temperatura guarda una relación lineal positiva con la respuesta. Algo que nos dice que el aumento en la temperatura parece favorecer la precipitación máxima.


```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* Precipitación máxima tiene un error mucho menor que las estimaciones anteriores, sin embargo, observamos mayor error en las zonas alejadas a los datos.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa. Aunque la magnitud de la varianza es baja.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* Vemos un comportamiento similar al de la precipitación promedio.

* Destaca la precipitación máxima a niveles altos en el estado de Sinaloa.

\newpage

### 4.2.12 Diciembre

```{r}
n_mes <- "Diciembre"
lluvia_mes = lluvia %>% dplyr::filter(mes==12)
```

#### Temperatura

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,lluvia_mes$teprom))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de Temperatura (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit temp. (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$teprom <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Temperatura estimada \n (",n_mes,")"), fill="Temp. prom.")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* En general, toda la zona tiene una temperatura promedio alta (casi de 20°C en toda la retícula), a excepción de la región noreste.

* Destaca que en la frontera con USA la temperatura promedio sea de alrededor de 5°C y con una volatilidad no muy alta.

#### Modelo lineal de precipitación promedio \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipprom}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$
```{r}
precipprom_ml <- lm (log(precipprom) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipprom_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux %>% t, "latex", caption = paste0("Coeficientes de log-precipitación promedio (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí, tal como lo veíamos venir desde el mes pasado, la variable de temperatura se ha vuelto ahora no significativa, algo que justo asemeja a lo que sucede en enero.

```{r,results='hide'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipprom_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=3.09,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de log-precipitación promedio (",n_mes,")"))
lines(vario_fit,col="red")
```



```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipprom (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='100%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación promedio (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

De estos mapas concluimos:

* La mayor concentración de datos observados se encuentra en el centro del mapa, donde el error está alrededor del cero, también se observa que a los extremos de tiene un error mucho más grande.

* En la zona cercana a las estaciones observadas se tiene menor varianza que en las zonas más alejadas, que son las áreas noreste y suroeste del mapa.


#### Estimación de precipitación promedio \newline

Con base en el modelo lineal creado anteriormente


$$
Y_{\texttt{precipprom}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$

```{r}
### ESTIMACIÓN DE PRECIPITACIÓN PROMEDIO
grid$precipprom <- exp(predict(precipprom_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipprom))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación promedio estimada (",n_mes,")"), fill="Precipitación promedio")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
```

Este mapa nos permite concluir que:

* Aquí la zona que destaca por tener una precipitación promedio baja es Baja California Sur.

* En las zonas cercanas al mar, hay una precipitación promedio intermedia.

* En las zonas centro de Sinaloa y Sonora parece que hay una precipitación promedio alta.

#### Modelo lineal de precipitación mínima \newline

Notemos que para este mes, la variable $y_\texttt{precipmin}$ tiene la siguiente propiedad

$$
q_{y_\texttt{precipmin}}(98.5\%)= `r quantile(lluvia_mes$precipmin,0.985)`
$$

Entonces, la predicción de esta variable debe ser prácticamente cero en todo el mapa.

#### Modelo lineal de precipitación máxima \newline

Vamos a construir el siguiente modelo lineal

$$
log(\text{\texttt{precipmax}}) \sim X_\text{\texttt{teprom}} + X_\text{\texttt{elev}}
$$

```{r}
###MODELO LINEAL PRECIPITACIÓN MÁXIMA
precipmax_ml <- lm (log(precipmax) ~ teprom + elev, data = lluvia_mes)
aux<-summary(precipmax_ml)
aux<-round(aux$coefficients[,c(1,4)],3)
colnames(aux)<-c("Coeficiente","p-value")
```


```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
kable(aux, "latex", caption = paste0("Coeficientes de log-precipitación máxima (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Aquí, tal como lo veíamos venir desde el mes pasado, la variable de temperatura se ha vuelto ahora no significativa, algo que justo asemeja a lo que sucede en enero.

```{r,results='hide',out.width='50%'}
###KRIGING DE RESIDUALES
#Creamos el geodata
geo <- as.geodata(cbind(lluvia_jit,precipmax_ml$residuals))
#Variograma empirico
vario_emp <- variog(geo)
#Ajuste de variograma
vario_fit <- variofit(vario_emp,nugget=0.15,cov.model="gaussian")
#Gráfica de variograma emírico vs ajuste
plot(vario_emp,main=paste0("Variograma de residuales de precipitación máxima (",n_mes,")"))
lines(vario_fit,col="red")
```

```{r}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
aux<-c(vario_fit$max.dist,vario_fit$practicalRange,vario_fit$nugget) %>% round(3)
aux <- aux %>% as.data.frame()
rownames(aux)<-c("Distancia Máxima","Rango","Pepita")
colnames(aux)<-"Parámetros"
kable(aux %>% t, "latex", caption = paste0("Parámetros del Vario-fit resid-precipmax (",n_mes,")."),
      booktabs = T,row.names = ) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

```{r,results='hide'}
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#Kriging
krig <- krige.conv(geo,loc=grid,krige=krige.control(obj.model=vario_fit))
```

\vspace{-2.5cm}

```{r,out.width='85%'}
#Agregamos el kriging de temperatura en la retícula
grid$error <- krig$predict
#Data frame de coordenadas con krig
krig_df <- data.frame(longitud = grid$longitud, latitud = grid$latitud,
                      predict = krig$predict, varianza = krig$krige.var)
#Gráfica estimación de kirging y varianza con barrita de escala :]
graphs <- list()
pred.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
pred.plot <- pred.plot + geom_tile(aes(fill = predict))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5)
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Error estimado de \n log-precipitación máxima (",n_mes,")"), fill="Error")
pred.plot <- pred.plot + mynamestheme
graphs$pred.plot <- pred.plot +  coord_equal()

var.plot <- ggplot(aes(x = longitud, y = latitud), data = krig_df)
var.plot <- var.plot + geom_tile(aes(fill = varianza))
var.plot <- var.plot + scale_fill_gradient(low = "blue", high = "yellow")
var.plot <- var.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen",size=0.5)
var.plot <- var.plot + geom_point(data = lluvia, colour = "darkgoldenrod4",size=0.5) 
var.plot <- var.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                            title = paste0("Varianza de estimación \n (",n_mes,")"), fill="Varianza")
var.plot <- var.plot + mynamestheme
graphs$var.plot <- var.plot + coord_equal()

egg::ggarrange(plots = graphs,
               ncol = 2, nrow = 1)
```

\vspace{-2.5cm}

* El error en la precipitación máxima es prácticamente cero e igual en todo el mapa.

* La volatilidad del error es considerablemente baja e igual en todo el mapa.

* Para los residuales, parece no haber un efecto geográfico que afecte la precipitación máxima.

#### Estimación de precipitación máxima \newline

Con base en el modelo lineal creado anteriormente

$$
Y_{\texttt{precipmax}} = exp \left( \beta_0 + \beta_1X_{\texttt{teprom}} + \beta_2 X_{\texttt{elev}} + \text{error}_\texttt{resid} \right)
$$


```{r,out.width='75%'}
### ESTIMACIÓN DE PRECIPITACIÓN MÁXIMA
grid$precipmax <- exp(predict(precipmax_ml,grid[,c("teprom","elev")]) + grid$error)

pred.plot <- ggplot(aes(x = longitud, y = latitud), data = grid)
pred.plot <- pred.plot + geom_tile(aes(fill = precipmax))
pred.plot <- pred.plot + scale_fill_gradient(low = "skyblue", high = "red")
pred.plot <- pred.plot + geom_point(data = contorno, aes(longitud, latitud), colour = "darkgreen")
pred.plot <- pred.plot + geom_point(data = lluvia, colour = "darkgoldenrod4")
pred.plot <- pred.plot + labs(y="Kilómetros 'y'", x = "Kilómetros 'x'",
                              title = paste0("Precipitación máxima estimada (",n_mes,")"), fill="Precipitación máxima")
pred.plot <- pred.plot + mynamestheme
pred.plot +  coord_equal()
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
```

En conclusión:

* En las zonas cercanas al mar, la precipitación máxima resulta ser baja en este mes.

* La precipitación máxima es más alta en zonas terrestres y en particular tiene un gran valor al norte de Sonora.

\newpage

# 5. Conclusiones

* Podemos ver que en efecto la volatilidad de los modelos aumenta considerablemente cuando se está lejos de los puntos de medición, que en este caso son las estaciones meteorológicas.

* En los meses con poca lluvia, parece que la relación lineal entre la temperatura y la precipitación es negativa, caso contrario para los meses con más lluvia.

* En general, el clima del mar se veía sesgado por el clima que presentaba la península, algo que tiene sentido pues los puntos de medición más cercanos al mar se encuentran en esta posición geográfica.

* La variable de elevación resultaba significativa para todos los modelos lineales que planteamos, de tal manera que esta es una medida importante para explicar la precipitación.

* La falta de volatilidad en la variable respuesta puede llegar a impedir los cálculos adecuados en cuestiones numéricas para el kriging. Una situación que sucedió repetidas veces en meses en los que la precipitación mínima era cero o prácticamente cero en todas las observaciones. 

* Es evidente que el comportamiento por mes de la precipitación tiene resultados diferentes. Parece entonces adecuado separar de esta forma los datos para poder hacer un análisis más certero.

