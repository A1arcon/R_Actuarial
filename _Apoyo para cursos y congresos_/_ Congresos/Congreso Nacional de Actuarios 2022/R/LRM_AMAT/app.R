

library(shiny)
library(dplyr)
library(scales)

# Define UI for application that draws a histogram
ui <- fluidPage(

    # Application title
    titlePanel("Límite Máximo de Retención (LMR)"),

    # Sidebar with a slider input for number of bins 
    sidebarLayout(
        sidebarPanel(
            sliderInput("LMR",
                        "Monto del LRM:",
                        min = 190000,
                        max = 800000,
                        value = 400000,
                        step = 10000),
            sliderInput("Reserva",
                        "Reserva (en millones):",
                        min = 25,
                        max = 45,
                        value = 35,
                        step = 2.5),
            sliderInput("EF",
                        "Valor esperado de la frecuencia relativa:",
                        min = 0.1,
                        max = 0.9,
                        value = 0.35,
                        step = 0.05),
            sliderInput("theta",
                        "Probabilidad de Siniestro:",
                        min = 0.1,
                        max = 0.9,
                        value = 0.25,
                        step = 0.05)
            
        ),

        # Show a plot of the generated distribution
        mainPanel(
           plotOutput("hist"),
           plotOutput("barplot"),
           plotOutput("media")
        )
    )
)

# Define server logic required to draw a histogram
server <- function(input, output) {

    # Función reactiva ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    S.LMR <- reactive({
        
        # Número de simulaciones
        n = 10000
        
        # Sumas aseguradas
        SA <- c(150000,150000,150000,150000,150000,150000,150000,150000,155400,161900,162200,163300,166600,169300,174600,174600,175600,177600,177600,178200,178500,183700,185200,186300,187300,187500,190900,194000,198700,199800,200500,201600,202100,204000,204200,204500,205300,206200,206400,206500,207800,207900,208800,210700,210800,211000,211400,211800,212200,212700,214400,215500,215800,217100,217700,219300,219700,219900,220300,220800,223700,224800,225800,227900,228500,229000,229500,230300,230400,230500,230700,231100,232200,232500,234200,234400,234800,235400,235400,235900,236700,237800,237800,237900,238700,238800,239400,239700,240600,241100,241200,241200,241600,242800,243400,244100,244200,244600,244600,245000,245900,246000,246100,246400,246500,248300,248600,249800,251500,251800,252300,252500,253200,253300,254700,256000,256600,257000,257500,259100,260000,260000,260800,260900,261100,261100,261200,261300,262000,262200,262400,263200,263800,264000,264500,264700,265000,265000,265800,266000,266200,266200,266400,268700,269400,270600,270600,270800,271400,271800,271900,272700,273300,273500,273800,275200,275300,276400,276600,276900,277500,279000,279400,279700,281500,282000,282200,282900,284800,285100,287400,288900,289500,289500,290100,290300,290800,290800,291100,291200,291300,291800,292500,292700,292700,292700,292800,293200,293200,293400,293600,293700,295000,295000,295100,296100,296500,296500,296600,296900,297400,297500,297900,298200,298300,298400,299000,299100,299200,299300,299800,300400,300500,300600,301000,301100,302300,302500,302600,302800,302900,303100,304000,304900,305400,305700,305900,306400,308000,309500,309900,310400,311000,311600,312400,313600,313800,314000,314400,317100,317300,317300,317600,317900,318200,318700,318900,319700,319700,320500,320600,320900,321000,321400,321600,321800,321800,322400,323300,323300,323600,324000,324500,325700,326000,327100,327200,327700,327800,327800,328200,328300,328400,328400,328500,328900,329200,330000,330100,330500,330600,330600,330800,331100,331300,331300,332600,332600,332700,332700,333600,333700,334600,334800,334900,335100,336600,336600,336700,337200,337900,338000,338200,338500,338600,340000,340200,340400,340400,340400,340700,340900,341200,342400,342500,342800,343500,343500,343600,343800,344300,344500,345000,345100,345100,345400,345600,345600,347000,347500,347600,348300,349500,349800,350200,350700,350800,351000,351100,351100,351500,352900,353100,354500,354600,355100,355900,356300,357300,357500,357700,357900,358400,358400,358900,358900,359000,359200,359800,359900,360600,361600,362300,363300,363600,363600,364300,364600,364900,365900,365900,367400,368800,368900,368900,368900,369200,369400,369600,369700,370000,370700,371800,371800,373100,373500,374000,374100,374900,374900,375200,375200,375700,375800,376600,377400,377700,377900,378000,378400,379500,380800,380900,382100,383800,384000,385500,385500,387000,387600,387900,390400,393100,393700,394000,395400,395500,396900,397800,399200,399400,399800,399900,401200,401700,402100,402800,402800,403300,404000,404300,405000,405400,406500,408000,408200,411500,412300,412500,413000,414000,414500,414500,416200,416300,416400,417300,417700,418300,418400,419100,419100,420600,420900,420900,421600,423500,425800,426700,429400,430200,431400,432100,432200,432200,432400,432500,433000,433100,434000,435400,435500,437300,441700,441900,443500,443900,444300,445200,445500,446600,447700,449700,449900,450300,451000,458100,461400,463400,466900,467600,467600,468400,469300,469600,470400,475400,477600,479300,479600,483400,484000,484900,487500,487600,488800,490800,494200,495800,498200,498300,500000,504100,507700,514300,517900,521300,522100,522200,523000,523500,524200,529000,530300,533300,534800,535200,536200,536500,541800,541800,544400,545300,546300,548700,549400,551900,552100,554100,556300,560200,562400,562800,564000,566900,566900,567600,569600,569900,570000,571000,573900,574200,575700,576600,579400,579900,580500,580600,581400,582300,582400,582800,583000,583900,583900,585200,587600,588400,589300,589400,590500,593300,594800,595800,597400,597800,598300,604000,605500,607300,608200,608700,608700,609100,611200,614000,614700,614900,615700,616900,617300,620800,621000,622200,623800,625200,625300,626800,627000,629000,629500,630200,634200,635300,635800,636600,640400,641000,641300,641600,642300,643500,644500,645800,645900,647600,647800,648100,648300,648500,649300,649400,649700,650600,653600,657100,659500,659800,660100,660400,661300,661800,661800,662200,664200,664200,664700,664800,666100,666200,666600,666900,667000,669400,669500,670300,670600,672400,672800,673200,673800,674100,675400,676000,677500,681200,681800,681800,683000,683900,685600,685900,689100,689200,690100,691600,692000,692500,692800,693800,694000,694300,694700,696100,700000,700700,703100,703400,704700,705000,705900,706100,709200,712800,712800,713200,713700,713900,714100,714600,717400,718700,719700,720100,722600,722600,723100,723400,724900,726400,727700,728300,731200,731700,732700,733900,736300,737200,737400,738100,743700,745800,746400,746900,747100,750700,750900,752000,752600,758000,758000,758600,759100,759800,761100,762300,764300,766800,769200,770400,772000,774500,785000,785500,785500,786100,790200,790500,790900,791500,803100,803900,807100,819000,819400,845600,845900,859400,861000,867900,1192100,1248500,1446800,1461600,1516900,1540400,1559100,1594900,1616200,1626300,1639600,1729100,1748600,1809500,1812600,1818600,1847000,1911800,2007000,2007000,2021400,2053600,2056200,2066600,2152300,2160400,2174500,2186800,2224300,2233600,2238700,2248000,2255000,2364700,2377800,2415700,2430500,2455900,2478000,2495600,2510800,2525600,2542100,2658800,2711800,2862800,2894100,2928000,3000000)
        
        # Frecuencia relativa (Porcentaje de la SA)
        EF <- input$EF #= E[F]
        
        # Parámetros del modelo
        theta <- input$theta
        
        # Reserva
        Reserva = input$Reserva*10^6
        
        S.LMR <- function(LMR){
            
            set.seed(1104)
            replicate(n = n,
                      expr = {
                          # Simulando los siniestros materializados
                          D <- rbinom(n = length(SA), size = 1, prob = theta)
                          # Total agregado de los siniestros materializados
                          sum(pmin(EF*SA, LMR) * D)
                      }) -> S_LMR
            
            # Probabilidad de Solvencia
            FS <- ecdf(x = S_LMR)
            
            p.ruina = 1 - FS(Reserva)
            
            return(list(p.ruina=p.ruina,S_LMR=S_LMR))
            
        }
        
        S.LMR
        
    })
    
    
    output$hist <- renderPlot({
        S.LMR <- S.LMR()
        
        plot_multi_histogram_density <- function(df, feature, label_column=NULL,
                                                 histogram=TRUE,density=TRUE,mean=TRUE,
                                                 title=NULL,subtitle=NULL,
                                                 ylab="Density",xlab=feature,
                                                 alpha_hist=0.7,alpha_dens=0.7,
                                                 color_vector="viridis") {
            
            # En caso de que no haya grupos
            if(is.null(label_column)){
                label_column = "Histograma"
                df[,label_column] = as.factor(rep("Datos",nrow(df)))
            }
            
            # Definimos los colores
            df[,label_column] <- df[,label_column] %>% as.factor()
            if(color_vector=="viridis"){
                colores = df[,label_column] %>% levels() %>% length() %>% viridis::viridis()
            }else if(color_vector=="rainbow"){
                colores = df[,label_column] %>% levels() %>% length() %>% rainbow()
            }else{
                colores = color_vector
            }
            
            library(ggplot2)
            plt <- ggplot(df, aes(x=df[,feature], 
                                  fill=df[,label_column]))
            
            # Histograma
            if(histogram){
                plt <- plt + geom_histogram(alpha=alpha_hist, position="identity", 
                                            aes(y = ..density..), color="black")
            }
            # Densidades
            if(density){
                plt <- plt + geom_density(alpha=alpha_dens)
            }
            # Caso raro...
            if(!histogram&!density){
                warning("No puedes tener 'histogram'=FALSE y 'density'=FALSE.")
                return()
            }
            
            # Le ponemos lo demás
            plt <- plt +
                # Relleno
                scale_fill_manual(name=label_column,values=colores)
            
            # Media de los histogramas
            if(mean){
                
                # Media global
                plt <- plt + geom_vline(aes(xintercept=mean(df[,feature],na.rm = TRUE),color="Global"),
                                        linetype="dashed", size=1)
                valores = c(Global="red")
                # Media por categoría
                if(length(colores)>1){
                    for(i in 1:length(colores)){
                        nivel = levels(df[,label_column])[i]
                        comando <- paste0("plt <- plt + geom_vline(aes(xintercept=mean(df[df[,label_column]=='",nivel,"',feature],na.rm = TRUE),color='",nivel,"'),linetype='dashed', size=1)")
                        eval(parse(text=comando))
                        valores[i+1] <- colores[i]
                        names(valores)[i+1] <- nivel
                    }
                }
                
                # Le ponemos los títulos
                plt <- plt + scale_color_manual(name = "Media",
                                                values = valores)
            }
            
            
            # Reserva
            plt <- plt + geom_vline(aes(xintercept=input$Reserva*10^6,color="Reserva"),
                                    linetype="dashed", size=1)
            valores = c(Reserva="blue")
            # Le ponemos los títulos
            plt <- plt + scale_color_manual(name = " ",
                                            values = valores)
            
            plt <- plt +
                # Eje Horizontal
                geom_hline(yintercept=0,color="black", size=1) +
                # Títulos
                labs(title=title,
                     subtitle=subtitle,
                     y=ylab, x=xlab)
            
            # Valor de retorno
            return(plt)
            
        }
        
        S_LMR <- S.LMR(input$LMR)$S_LMR
        S_LMR_inicial <- S.LMR(400000)$S_LMR
        
        df <- data.frame(LMR=c(S_LMR,S_LMR_inicial),
                         Leyenda=rep(c("Actual","Inicial"),each=length(S_LMR)))
        plot_multi_histogram_density(df = df,feature = "LMR",label_column = "Leyenda",
                                     histogram = T,density = F,mean=F,
                                     title = "Péridas agregadas con LMR",subtitle = "",ylab = "Histograma",xlab = "S",
                                     alpha_hist = 0.5,alpha_dens = 0.25) +
            scale_x_continuous(labels = unit_format(unit = "M", scale = 1e-6))
        
    })
    
    output$barplot <- renderPlot({
        
        # Número de simulaciones
        n = 10000
        
        S.LMR <- S.LMR()
        S_LMR <- S.LMR(input$LMR)$S_LMR
        barra <- table(S_LMR>input$Reserva*10^6)/n
        if(length(barra)==2){
            names(barra) <- c("Solvencia","Ruina")
        }else if(names(barra)=="TRUE"){
            barra <- c(0,barra)
            names(barra) <- c("Solvencia","Ruina")
        }else{
            barra <- c(barra,0)
            names(barra) <- c("Solvencia","Ruina")
        }
        
        barplot(barra,col=c("green","red"),ylim = c(0,1.25),main="Probabilidad de Ruina")
        abline(h = 0.95,col="blue",lwd=2)
        
        legend("top", legend=c("Nivel de confianza 0.95"),
               col=c("blue"), lty=1, cex=0.8, lwd=2,
               title="Línea", text.font=4, bg='lightblue')
        
    })
    
    output$media <- renderPlot({
        
        # Sumas aseguradas
        SA <- c(150000,150000,150000,150000,150000,150000,150000,150000,155400,161900,162200,163300,166600,169300,174600,174600,175600,177600,177600,178200,178500,183700,185200,186300,187300,187500,190900,194000,198700,199800,200500,201600,202100,204000,204200,204500,205300,206200,206400,206500,207800,207900,208800,210700,210800,211000,211400,211800,212200,212700,214400,215500,215800,217100,217700,219300,219700,219900,220300,220800,223700,224800,225800,227900,228500,229000,229500,230300,230400,230500,230700,231100,232200,232500,234200,234400,234800,235400,235400,235900,236700,237800,237800,237900,238700,238800,239400,239700,240600,241100,241200,241200,241600,242800,243400,244100,244200,244600,244600,245000,245900,246000,246100,246400,246500,248300,248600,249800,251500,251800,252300,252500,253200,253300,254700,256000,256600,257000,257500,259100,260000,260000,260800,260900,261100,261100,261200,261300,262000,262200,262400,263200,263800,264000,264500,264700,265000,265000,265800,266000,266200,266200,266400,268700,269400,270600,270600,270800,271400,271800,271900,272700,273300,273500,273800,275200,275300,276400,276600,276900,277500,279000,279400,279700,281500,282000,282200,282900,284800,285100,287400,288900,289500,289500,290100,290300,290800,290800,291100,291200,291300,291800,292500,292700,292700,292700,292800,293200,293200,293400,293600,293700,295000,295000,295100,296100,296500,296500,296600,296900,297400,297500,297900,298200,298300,298400,299000,299100,299200,299300,299800,300400,300500,300600,301000,301100,302300,302500,302600,302800,302900,303100,304000,304900,305400,305700,305900,306400,308000,309500,309900,310400,311000,311600,312400,313600,313800,314000,314400,317100,317300,317300,317600,317900,318200,318700,318900,319700,319700,320500,320600,320900,321000,321400,321600,321800,321800,322400,323300,323300,323600,324000,324500,325700,326000,327100,327200,327700,327800,327800,328200,328300,328400,328400,328500,328900,329200,330000,330100,330500,330600,330600,330800,331100,331300,331300,332600,332600,332700,332700,333600,333700,334600,334800,334900,335100,336600,336600,336700,337200,337900,338000,338200,338500,338600,340000,340200,340400,340400,340400,340700,340900,341200,342400,342500,342800,343500,343500,343600,343800,344300,344500,345000,345100,345100,345400,345600,345600,347000,347500,347600,348300,349500,349800,350200,350700,350800,351000,351100,351100,351500,352900,353100,354500,354600,355100,355900,356300,357300,357500,357700,357900,358400,358400,358900,358900,359000,359200,359800,359900,360600,361600,362300,363300,363600,363600,364300,364600,364900,365900,365900,367400,368800,368900,368900,368900,369200,369400,369600,369700,370000,370700,371800,371800,373100,373500,374000,374100,374900,374900,375200,375200,375700,375800,376600,377400,377700,377900,378000,378400,379500,380800,380900,382100,383800,384000,385500,385500,387000,387600,387900,390400,393100,393700,394000,395400,395500,396900,397800,399200,399400,399800,399900,401200,401700,402100,402800,402800,403300,404000,404300,405000,405400,406500,408000,408200,411500,412300,412500,413000,414000,414500,414500,416200,416300,416400,417300,417700,418300,418400,419100,419100,420600,420900,420900,421600,423500,425800,426700,429400,430200,431400,432100,432200,432200,432400,432500,433000,433100,434000,435400,435500,437300,441700,441900,443500,443900,444300,445200,445500,446600,447700,449700,449900,450300,451000,458100,461400,463400,466900,467600,467600,468400,469300,469600,470400,475400,477600,479300,479600,483400,484000,484900,487500,487600,488800,490800,494200,495800,498200,498300,500000,504100,507700,514300,517900,521300,522100,522200,523000,523500,524200,529000,530300,533300,534800,535200,536200,536500,541800,541800,544400,545300,546300,548700,549400,551900,552100,554100,556300,560200,562400,562800,564000,566900,566900,567600,569600,569900,570000,571000,573900,574200,575700,576600,579400,579900,580500,580600,581400,582300,582400,582800,583000,583900,583900,585200,587600,588400,589300,589400,590500,593300,594800,595800,597400,597800,598300,604000,605500,607300,608200,608700,608700,609100,611200,614000,614700,614900,615700,616900,617300,620800,621000,622200,623800,625200,625300,626800,627000,629000,629500,630200,634200,635300,635800,636600,640400,641000,641300,641600,642300,643500,644500,645800,645900,647600,647800,648100,648300,648500,649300,649400,649700,650600,653600,657100,659500,659800,660100,660400,661300,661800,661800,662200,664200,664200,664700,664800,666100,666200,666600,666900,667000,669400,669500,670300,670600,672400,672800,673200,673800,674100,675400,676000,677500,681200,681800,681800,683000,683900,685600,685900,689100,689200,690100,691600,692000,692500,692800,693800,694000,694300,694700,696100,700000,700700,703100,703400,704700,705000,705900,706100,709200,712800,712800,713200,713700,713900,714100,714600,717400,718700,719700,720100,722600,722600,723100,723400,724900,726400,727700,728300,731200,731700,732700,733900,736300,737200,737400,738100,743700,745800,746400,746900,747100,750700,750900,752000,752600,758000,758000,758600,759100,759800,761100,762300,764300,766800,769200,770400,772000,774500,785000,785500,785500,786100,790200,790500,790900,791500,803100,803900,807100,819000,819400,845600,845900,859400,861000,867900,1192100,1248500,1446800,1461600,1516900,1540400,1559100,1594900,1616200,1626300,1639600,1729100,1748600,1809500,1812600,1818600,1847000,1911800,2007000,2007000,2021400,2053600,2056200,2066600,2152300,2160400,2174500,2186800,2224300,2233600,2238700,2248000,2255000,2364700,2377800,2415700,2430500,2455900,2478000,2495600,2510800,2525600,2542100,2658800,2711800,2862800,2894100,2928000,3000000)
        
        # Frecuencia relativa (Porcentaje de la SA)
        EF <- input$EF #= E[F]
        
        # Parámetros del modelo
        theta <- input$theta
        
        
        
        fondo_plot <- function(fondo.col="#ebebeb",grid.col="white",lwd=2){
            # Fondo
            rect(par("usr")[1], par("usr")[3],
                 par("usr")[2], par("usr")[4],
                 col = fondo.col)
            grid(col=grid.col,lwd=lwd)
        }
        
        S.LMR <- S.LMR()
        S_LMR <- S.LMR(input$LMR)$S_LMR
        
        plot(cummean(S_LMR),type = "l",
             main="Ley de los Grandes Números",
             xlab="Número de simulaciones",
             ylab="Media acumulada")
        fondo_plot()
        lines(cummean(S_LMR))
        abline(h = theta*sum(pmin(EF*SA, input$LMR)),col="red",lwd=2)
        
        legend("topright", legend=c("Media", "Esperanza"),
               col=c("black", "red"), lty=1, cex=0.8, lwd=2,
               title="Líneas", text.font=4, bg='lightblue')
        
    })
    
}

# Run the application 
shinyApp(ui = ui, server = server)
